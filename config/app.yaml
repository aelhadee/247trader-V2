# 247trader-v2 Application Configuration
# Rules-first, AI-optional architecture

app:
  name: "247trader-v2"
  version: "2.0.0"
  mode: "LIVE"  # DRY_RUN | PAPER | LIVE

exchange:
  name: "coinbase"
  api_key: "${COINBASE_API_KEY}"
  api_secret: "${COINBASE_API_SECRET}"
  
  # Read-only mode for safety (must explicitly set to false for LIVE trading)
  read_only: false
  
  # Rate limits (per second)
  rate_limit:
    public: 10
    private: 5

loop:
  # Main execution loop
  interval_minutes: 1.0
  
  # Skip weekends/holidays
  skip_weekends: false
  
  # Timezone
  timezone: "UTC"
  
  # Jitter and auto-backoff (prevents synchronized bursts and overload)
  interval:
    seconds: 60              # Base interval
    jitter_pct: 10          # ±10% randomization
  utilization_autobackoff:
    target_util_pct: 70     # Trigger backoff at 70% utilization
    backoff_seconds: 15     # Add 15s when over target
  universe_cache_seconds: 300

auto_tune:
  # Bounded auto-loosening for prolonged zero-trigger periods
  zero_trigger_cycles: 12   # If 12 consecutive cycles have 0 triggers...
  loosen:
    pct_change_15m_delta: -0.2    # Reduce 15m threshold by 0.2%
    pct_change_60m_delta: -0.3    # Reduce 60m threshold by 0.3%
    min_conviction_delta: -0.02   # Reduce conviction by 0.02
  floors:
    pct_change_15m: 1.2     # Do not go below 1.2% for 15m
    pct_change_60m: 2.5     # Do not go below 2.5% for 60m
    min_conviction: 0.30    # Do not go below 0.30 conviction

logging:
  level: "INFO"  # DEBUG | INFO | WARNING | ERROR
  format: "json"  # json | text
  
  # File output
  file: "logs/247trader-v2.log"
  rotate: true
  max_bytes: 10485760  # 10MB
  backup_count: 5
  
  # Structured fields
  include_timestamps: true
  include_hostname: true
  
  # Sensitive data redaction
  redact_api_keys: true
  redact_tokens: true

state:
  # State persistence
  store: "sqlite"  # sqlite | redis | memory
  path: "data/state.db"
  
  # How often to persist
  persist_interval_seconds: 60
  
  # Backup state
  backup_enabled: true
  backup_interval_hours: 24

monitoring:
  # Health checks
  healthcheck_enabled: false
  healthcheck_port: 8080
  
  # Metrics
  metrics_enabled: true
  metrics_port: 9090
  
  # Prometheus exporter
  prometheus_enabled: true
  prometheus_port: 8000
  
  # Alerts with dedupe and escalation
  alerts_enabled: false
  alerts:
    webhook_env: "ALERT_WEBHOOK_URL"
    min_severity: "warning"
    dry_run: false
    timeout_seconds: 5
    # Deduplication: suppress identical alerts within 60s window
    dedupe_seconds: 60.0
    # Escalation: boost severity after 2m unresolved
    escalation_seconds: 120.0
    escalation_webhook_url: "${ESCALATION_WEBHOOK_URL}"  # Optional separate webhook
    escalation_severity_boost: 1  # INFO→WARNING, WARNING→CRITICAL

ai:
  # AI Advisor: filters/resizes proposals between rules_engine and risk_engine
  # Core principle: AI can only SHRINK, SKIP, or TAG - never increase size
  enabled: false  # Start disabled - enable after testing
  
  # Model provider and configuration
  provider: "anthropic"  # openai | anthropic | mock
  model: "claude-sonnet-4-5-20250929"  # Model name (provider-specific)
  api_key: "${ANTHROPIC_API_KEY}"  # or ${OPENAI_API_KEY}
  
  # Safety constraints
  timeout_s: 1.0              # Hard timeout for model calls (fail-closed)
  max_scale_up: 1.0           # NEVER >1.0 in v1 (AI cannot increase sizes)
  fallback_on_error: true     # On error → bypass AI (safe default)
  
  # Risk mode influence
  default_risk_mode: "NORMAL"           # OFF | DEFENSIVE | NORMAL | AGGRESSIVE
  allow_risk_mode_override: false       # Let AI suggest risk mode (disable initially)
  
  # Observability
  log_decisions: true         # Log all AI decisions for audit
  metrics_enabled: true       # Export AI metrics (latency, decision rates)
  
  # Dual-Trader Mode: Run AI trader in parallel with local rules, then arbitrate
  # Architecture: Local trader vs AI trader → Meta-arbitrator → RiskEngine → ExecutionEngine
  dual_trader:
    enabled: false  # Start disabled - requires careful testing
    
    # AI Trader (Model #1): Generates independent trade proposals
    provider: "openai"  # openai | anthropic | mock
    model: "gpt-5-mini-2025-08-07"
    api_key: "${OPENAI_API_KEY}"
    timeout_s: 2.0
    max_decisions: 5  # Max proposals per cycle
    min_confidence: 0.0  # Filter out low-confidence decisions
    enable_hold_signals: false  # Whether to log HOLD signals
    
    # Meta-Arbitration: Deterministic rules for merging local + AI proposals
    arbitration:
      min_ai_confidence: 0.6  # Minimum AI confidence to use single AI proposal
      ai_override_threshold: 0.7  # AI confidence needed to override local in conflicts
      local_weak_conviction: 0.35  # Local conviction considered "weak"
      ai_confidence_advantage: 0.25  # Gap needed for AI to override weak local
      blend_mode: "conservative"  # conservative (min) | average
    
    # AI Arbiter (Model #2): Optional tie-breaker for unresolved conflicts
    arbiter:
      enabled: false  # Start with deterministic arbitration only
      provider: "anthropic"
      model: "claude-sonnet-4-5-20250929"
      api_key: "${ANTHROPIC_API_KEY}"
      timeout_s: 1.5
