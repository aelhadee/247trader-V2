# 247trader-v2 Policy Configuration
# Hard constraints that NO component (rules, AI, or human) can violate

risk:
  # Global exposure limits
  max_total_at_risk_pct: 15.0  # 15% of NLV in active risk positions
  
  # Per-asset limits
  max_position_size_pct: 5.0  # 5% of NLV per coin
  max_per_asset_pct: 5.0      # Alias for spec compatibility
  min_position_size_pct: 0.5
  
  # Per-theme limits (cluster exposure)
  max_per_theme_pct:
    L2: 10.0      # 10% across ARB/OP/STRK/etc
    MEME: 5.0     # 5% max in meme coins
    DEFI: 10.0    # 10% max in DeFi
  
  # Drawdown controls
  daily_stop_pnl_pct: -3.0    # -3% NLV on day → stop new trades
  weekly_stop_pnl_pct: -7.0   # -7% week → tighten / only de-risk
  max_drawdown_pct: 10.0
  
  # Trade frequency
  max_trades_per_day: 10
  max_trades_per_hour: 4
  max_new_trades_per_hour: 4  # New trades per hour (spec requirement)
  
  # Cooldown after losses (global)
  cooldown_after_loss_trades: 3  # 3 losing trades in row → pause
  cooldown_minutes: 60
  
  # Per-symbol cooldowns
  per_symbol_cooldown_enabled: true
  per_symbol_cooldown_minutes: 30  # Wait 30min after any loss on a symbol
  per_symbol_cooldown_after_stop: 60  # Wait 60min after stop-loss hit
  
  # Minimum trade size
  min_trade_notional_usd: 5  # Skip dust (lowered for very small account)
  
  # Hard stops per position
  stop_loss_pct: 8.0
  take_profit_pct: 15.0

position_sizing:
  # Base sizing method
  method: "risk_parity"  # fixed | risk_parity | kelly
  
  # Risk per trade (when using risk_parity)
  risk_per_trade_pct: 1.0
  
  # Fixed size (when using fixed method)
  fixed_size_usd: 100.0
  
  # Sizing constraints
  min_order_usd: 10.0
  max_order_usd: 10000.0
  
  # Pyramid rules
  allow_pyramiding: false
  max_pyramid_positions: 2

liquidity:
  # Unified liquidity filters (single source of truth)
  min_24h_volume_usd: 8_000_000     # $8M minimum (unified policy)
  max_spread_bps: 80                # 0.80% max spread (unified policy)
  min_depth_20bps_usd: 10_000       # $10K depth within 20bps (broader universe, monitor slippage)

triggers:
  # Price-move based triggers
  price_move:
    pct_15m: 3.0                    # abs move >= 3.0% in 15m
    pct_60m: 5.0                    # abs move >= 5.0% in 60m

  # Volume spike trigger
  volume_spike:
    ratio_1h_vs_24h: 1.8            # last 1h >= 1.8x average hourly

  # Breakout / breakdown trigger
  breakout:
    lookback_hours: 24              # new 24h high/low + volume confirmation

  # Minimum combined trigger score (if you implement scoring)
  min_score: 0.2

strategy:
  # Base target allocation per asset tier (fraction of NLV)
  base_position_pct:
    tier1: 0.02                     # 2% NLV per Tier1 (BTC, ETH, SOL, etc.)
    tier2: 0.01                     # 1% NLV per Tier2
    tier3: 0.005                    # 0.5% NLV per Tier3 (if/when used)

  max_open_positions: 8             # cap simultaneous distinct holdings

  # Require at least this conviction from rules to emit a proposal
  min_conviction_to_propose: 0.45    # 0..1 (below this = no trade)

microstructure:
  # Liquidity filters moved to top-level 'liquidity'; avoid duplication.
  # Retain only execution-time microstructure guardrails.
  # Slippage protection
  max_expected_slippage_bps: 50  # 0.50%
  # Quote freshness
  max_quote_age_seconds: 30

circuit_breakers:
  # Data staleness limits
  max_quote_age_seconds: 60          # Reject quotes older than 60s
  max_ohlcv_age_seconds: 300         # Reject candles older than 5min
  
  # API health monitoring
  max_consecutive_api_errors: 3      # Trip breaker after 3 consecutive API failures
  api_error_window_seconds: 300      # Reset error counter after 5min of success
  
  # Exchange health checks
  check_exchange_status: true        # Verify exchange is operational
  halt_on_maintenance: true          # Stop trading during maintenance windows
  
  # Volatility circuit breaker
  max_realized_volatility_pct: 150   # Halt if realized vol > 150% annualized
  volatility_lookback_hours: 24      # Calculate vol over last 24h
  
  # Universe health
  min_eligible_assets: 2             # Need at least 2 eligible assets to trade
  
  # Rate limit protection
  pause_on_rate_limit: true          # Pause cycle if rate limited
  rate_limit_cooldown_seconds: 60    # Wait 60s after rate limit before resuming

regime:
  # Market regime adjustments
  enabled: true
  
  # Regime-specific multipliers (applied to position sizing)
  bull:
    position_size_multiplier: 1.2
    max_positions: 5
  chop:
    position_size_multiplier: 0.8
    max_positions: 3
  bear:
    position_size_multiplier: 0.5
    max_positions: 2
  crash:
    position_size_multiplier: 0.0  # No new positions
    max_positions: 0

execution:
  # Fee structure (Coinbase Advanced Trade)
  maker_fee_bps: 40   # 0.40% maker fee (post-only orders)
  taker_fee_bps: 60   # 0.60% taker fee (market/IOC orders)
  
  # Order types
  default_order_type: "limit_post_only"  # Phase 1: conservative
  # Auto-convert USD → USDC to honor preferred quote (when needed for BUYs)
  auto_convert_preferred_quote: true
  # Clamp tiny trades up to the minimum notional to avoid rejects
  clamp_small_trades: true
  # Use market orders instead of post-only limits for very small trades (to avoid repeated $5 failures)
  small_order_market_threshold_usd: 6.0
  
  # Post-trade reconciliation
  post_trade_reconcile_wait_seconds: 0.5  # Wait after trade before reconciling fills
  # Cooldown after a failed attempt (precision/limit reject) before retrying same symbol
  failed_order_cooldown_seconds: 180
  
  # Quote currency preferences (in order of preference)
  # System will use first available currency with sufficient balance
  preferred_quote_currencies:
    - "USDC"  # Stablecoin preferred
    - "USD"   # Fiat
    - "USDT"  # Alternative stablecoin
    - "BTC"   # Major crypto
    - "ETH"   # Major crypto
  
  # Hard guardrails
  max_slippage_bps: 40              # 0.40% max allowed vs reference
  hard_max_spread_bps: 80           # must align with liquidity.max_spread_bps
  
  # Order management
  cancel_after_seconds: 60          # cancel resting orders if not filled
  partial_fill_min_pct: 0.25        # ignore fills <25% when assessing success
  
  # Limit order behavior
  limit_offset_bps: 5               # Post limit 5bps inside mid
  limit_timeout_seconds: 30
  
  # Post-trade confirmation
  require_fill_confirmation: true
  fill_timeout_seconds: 60
  
  # Retry logic
  max_retries: 3
  retry_delay_seconds: 5
  
  # Volatility-aware sizing: cut risk in crazy tape
  high_volatility:
    lookback_minutes: 60
    move_threshold_pct: 8.0         # if asset moves >8% in 1h
    size_reduction_factor: 0.5      # halve proposed size

portfolio_management:
  # Automatically liquidate assets that are excluded or currently ineligible
  auto_liquidate_ineligible: true
  # Only liquidate holdings worth at least this much (USD equivalent)
  min_liquidation_value_usd: 10
  # Cap liquidations per cycle to avoid mass sells
  max_liquidations_per_cycle: 2
  # Attempt to free capital by liquidating worst-performing holding when stable buying power is insufficient
  auto_rebalance_worst_performer: true

ai:
  # AI module configuration
  enabled: false  # Start with rules-only
  
  # Model selection
  m1_model: "gpt-4o"  # Fundamental analyst
  m2_model: "gpt-4o"  # Quantitative analyst
  m3_model: "o3-mini"  # Arbitrator/governor
  
  # API configuration
  openai_api_key: "${OPENAI_API_KEY}"
  
  # AI constraints
  ai_can_create_symbols: false  # AI can only veto/adjust rule proposals
  ai_can_override_risk: false  # AI cannot violate risk rules
  ai_max_position_adjustment_pct: 20  # AI can adjust size by ±20%
  
  # News sources (allowlist only)
  news_sources:
    - "coindesk.com"
    - "theblock.co"
    - "cointelegraph.com"
  
  # Rate limits
  max_ai_calls_per_hour: 60
  
  # Cost controls
  max_cost_per_cycle_usd: 2.0

governance:
  # Decision logging
  require_decision_reasoning: true
  min_reasoning_length: 50
  
  # Audit trail
  log_all_decisions: true
  log_ai_prompts: true
  log_ai_responses: true
  
  # Human override
  allow_manual_override: true
  require_override_reason: true
  
  # Kill switches
  kill_switch_enabled: true
  kill_switch_file: "data/KILL_SWITCH"  # Create this file to halt
  
  # Emergency contacts
  emergency_slack_webhook: "${SLACK_WEBHOOK_URL}"
  emergency_email: "${ALERT_EMAIL}"

data:
  # Data quality guardrails
  max_age_s: 60  # Max age for OHLCV data (seconds)
  max_quote_staleness_seconds: 30  # Max age for quotes (seconds)

circuit_breaker:
  # API health monitoring
  api_error_threshold: 5  # Errors before circuit breaker
  api_error_window_minutes: 5  # Window for error tracking
  rate_limit_threshold: 3  # Rate limits before circuit breaker
  rate_limit_window_minutes: 10  # Window for rate limit tracking
